receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318
        cors:
          allowed_origins:
            - "http://*"
            - "https://*"

processors:
  batch:
    timeout: 10s
    send_batch_size: 1024

  memory_limiter:
    check_interval: 1s
    limit_mib: 512

  resource:
    attributes:
      - key: deployment.environment
        value: "local"
        action: upsert
      - key: service.namespace
        value: "easytrade"
        action: upsert

  attributes:
    actions:
      - key: http.url
        action: delete
      - key: http.request.header.authorization
        action: delete

  # Convert cumulative metrics to delta temporality
  # Used only for Dynatrace exporter (Dynatrace requires delta metrics)
  cumulativetodelta:

exporters:
  # Export traces to Jaeger (configurable via JAEGER_ENDPOINT env var)
  # Uncomment and configure when JAEGER_ENDPOINT is set
  # otlp/jaeger:
  #   endpoint: ${env:JAEGER_ENDPOINT}
  #   tls:
  #     insecure: ${env:JAEGER_INSECURE}
  #   headers:
  #     Authorization: ${env:JAEGER_AUTH_HEADER}

  # Export logs to Loki (configurable via LOKI_ENDPOINT env var)
  # Uncomment and configure when LOKI_ENDPOINT is set
  # loki:
  #   endpoint: ${env:LOKI_ENDPOINT}
  #   headers:
  #     Authorization: ${env:LOKI_AUTH_HEADER}

  # Export metrics to Prometheus (Prometheus scrapes from this endpoint)
  # External Prometheus should scrape http://<otel-collector-host>:8889/metrics
  # Configure your external Prometheus to scrape this endpoint:
  # scrape_configs:
  #   - job_name: 'otel-collector'
  #     static_configs:
  #       - targets: ['<otel-collector-host>:8889']
  prometheus:
    endpoint: "0.0.0.0:8889"
    namespace: easytrade
    send_timestamps: true
    metric_expiration: 5m
    resource_to_telemetry_conversion:
      enabled: true

  # Export metrics to VictoriaMetrics via Prometheus remote write
  # Uncomment and configure when VICTORIAMETRICS_ENDPOINT is set
  # prometheusremotewrite/victoriametrics:
  #   endpoint: ${env:VICTORIAMETRICS_ENDPOINT}
  #   headers:
  #     Authorization: ${env:VICTORIAMETRICS_AUTH_HEADER}
  #   external_labels:
  #     cluster: easytrade
  #     environment: ${env:VICTORIAMETRICS_ENVIRONMENT:-production}

  # Export traces, metrics, and logs to Dynatrace via OTLP HTTP
  # Dynatrace only supports OTLP over HTTP (not gRPC)
  # Configured via DYNATRACE_ENDPOINT and DYNATRACE_AUTH_HEADER env vars
  # Endpoint format: https://{tenant}.apps.dynatrace.com/api/v2/otlp
  otlphttp/dynatrace:
    endpoint: ${env:DYNATRACE_ENDPOINT}
    tls:
      insecure: false
    headers:
      Authorization: ${env:DYNATRACE_AUTH_HEADER}

  # Debug exporter (optional, for troubleshooting)
  logging:
    loglevel: info
    sampling_initial: 5
    sampling_thereafter: 200

connectors:
  spanmetrics:
    histogram:
      explicit:
        buckets: [0.001, 0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10]
    dimensions:
      - name: http.method
      - name: http.status_code
      # Note: service.name is automatically included, don't add it explicitly
    exemplars:
      enabled: true

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [memory_limiter, batch, resource, attributes]
      # Export traces to Dynatrace and logging
      exporters: [otlphttp/dynatrace, logging, spanmetrics]

    metrics:
      receivers: [otlp, spanmetrics]
      processors: [memory_limiter, batch, resource]
      # Prometheus exporter is always available (exposes metrics endpoint)
      exporters: [prometheus, logging]

    # Separate metrics pipeline for Dynatrace with delta temporality
    # Dynatrace requires delta metrics, while Prometheus requires cumulative
    metrics/dynatrace:
      receivers: [otlp, spanmetrics]
      processors: [memory_limiter, batch, resource, cumulativetodelta]
      exporters: [otlphttp/dynatrace]

    logs:
      receivers: [otlp]
      processors: [memory_limiter, batch, resource]
      # Export logs to Dynatrace and logging
      exporters: [otlphttp/dynatrace, logging]

  telemetry:
    logs:
      level: info
    metrics:
      address: 0.0.0.0:8888
