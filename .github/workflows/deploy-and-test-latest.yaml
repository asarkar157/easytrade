name: Deploy and test easytrade
on:
  push:
    branches:
      - "main"
  workflow_dispatch:
    inputs:
      tag:
        description: 'Docker image tag to use (defaults to latest)'
        required: false
        type: string
        default: 'latest'
      use_local_images:
        description: 'Use locally built images instead of pulling from registry'
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      tag:
        description: 'Docker image tag to use (defaults to latest)'
        required: false
        type: string
        default: 'latest'
      use_local_images:
        description: 'Use locally built images instead of pulling from registry'
        required: false
        type: boolean
        default: false
    secrets:
      GITHUB_TOKEN:
        required: false  # Automatically available, but can be explicitly passed
      JAEGER_ENDPOINT:
        required: false
      JAEGER_USERNAME:
        required: false
      JAEGER_PASSWORD:
        required: false
      JAEGER_INSECURE:
        required: false
      LOKI_ENDPOINT:
        required: false
      LOKI_USERNAME:
        required: false
      LOKI_PASSWORD:
        required: false
      VICTORIAMETRICS_ENDPOINT:
        required: false
      VICTORIAMETRICS_USERNAME:
        required: false
      VICTORIAMETRICS_PASSWORD:
        required: false
      VICTORIAMETRICS_ENVIRONMENT:
        required: false
      DYNATRACE_TENANT_URL:
        required: false
      DYNATRACE_PLATFORM_TOKEN:
        required: false
      OQR_CLIENT_ID:
        required: false
      OQR_CLIENT_SECRET:
        required: false
      OQR_URL:
        required: false
      SSO_URL:
        required: false

env:
  SKAFFOLD_DEFAULT_REPO: ghcr.io/${{ github.repository_owner }}

jobs:
  deploy-easytrade:
    runs-on: ubuntu-24.04
    # Skip job if this is a push event and commit message doesn't contain 'deploy'
    # workflow_dispatch and workflow_call events will always run
    if: github.event_name != 'push' || contains(github.event.head_commit.message, 'deploy') || contains(github.event.head_commit.message, 'Deploy') || contains(github.event.head_commit.message, 'DEPLOY')
    permissions:
      contents: read
      packages: read  # Read-only since this workflow only pulls images
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Compose
        run: |
          docker compose version

      - name: Start observability stack
        working-directory: ./observability
        env:
          JAEGER_ENDPOINT: ${{ secrets.JAEGER_ENDPOINT }}
          LOKI_ENDPOINT: ${{ secrets.LOKI_ENDPOINT }}
          JAEGER_INSECURE: ${{ secrets.JAEGER_INSECURE || 'false' }}
          VICTORIAMETRICS_ENDPOINT: ${{ secrets.VICTORIAMETRICS_ENDPOINT }}
          VICTORIAMETRICS_ENVIRONMENT: ${{ secrets.VICTORIAMETRICS_ENVIRONMENT || 'production' }}
          DYNATRACE_TENANT_URL: ${{ secrets.DYNATRACE_TENANT_URL }}
          DYNATRACE_PLATFORM_TOKEN: ${{ secrets.DYNATRACE_PLATFORM_TOKEN }}
        run: |
          # Generate Basic Auth headers if username/password are provided
          if [ -n "${{ secrets.JAEGER_USERNAME }}" ] && [ -n "${{ secrets.JAEGER_PASSWORD }}" ]; then
            export JAEGER_AUTH_HEADER="Basic $(echo -n '${{ secrets.JAEGER_USERNAME }}:${{ secrets.JAEGER_PASSWORD }}' | base64 | tr -d '\n')"
          fi
          
          if [ -n "${{ secrets.LOKI_USERNAME }}" ] && [ -n "${{ secrets.LOKI_PASSWORD }}" ]; then
            export LOKI_AUTH_HEADER="Basic $(echo -n '${{ secrets.LOKI_USERNAME }}:${{ secrets.LOKI_PASSWORD }}' | base64 | tr -d '\n')"
          fi
          
          if [ -n "${{ secrets.VICTORIAMETRICS_USERNAME }}" ] && [ -n "${{ secrets.VICTORIAMETRICS_PASSWORD }}" ]; then
            export VICTORIAMETRICS_AUTH_HEADER="Basic $(echo -n '${{ secrets.VICTORIAMETRICS_USERNAME }}:${{ secrets.VICTORIAMETRICS_PASSWORD }}' | base64 | tr -d '\n')"
          fi
          
          # Construct Dynatrace endpoint and auth header if tenant URL and token are provided
          if [ -n "${{ secrets.DYNATRACE_TENANT_URL }}" ] && [ -n "${{ secrets.DYNATRACE_PLATFORM_TOKEN }}" ]; then
            # Remove trailing slash from tenant URL if present, then append /api/v2/otlp
            TENANT_URL=$(echo "${{ secrets.DYNATRACE_TENANT_URL }}" | sed 's|/*$||')
            export DYNATRACE_ENDPOINT="${TENANT_URL}/api/v2/otlp"
            export DYNATRACE_AUTH_HEADER="Bearer ${{ secrets.DYNATRACE_PLATFORM_TOKEN }}"
          fi
          
          docker compose -f docker-compose-observability.yml up -d

      - name: Wait for observability stack to be ready
        run: |
          echo "Waiting for OpenTelemetry Collector to be ready..."
          timeout 60 bash -c 'until docker exec otel-collector wget -q --spider http://localhost:13133 2>/dev/null; do sleep 2; done' || true

      - name: Start EasyTrade services
        env:
          REGISTRY: ${{ env.SKAFFOLD_DEFAULT_REPO }}
        run: |
          # Use tag from input (defaults to latest if not provided)
          # If tag is a full commit SHA, use first 7 characters (for compatibility)
          # Handles workflow_dispatch, workflow_call, and push triggers
          TAG_INPUT="${{ inputs.tag }}"
          if [ -n "$TAG_INPUT" ] && [ "$TAG_INPUT" != "latest" ]; then
            export TAG=$(echo "$TAG_INPUT" | cut -c 1-7)
          else
            export TAG=latest
          fi
          
          # If use_local_images is true, set REGISTRY to empty string to use local images
          if [ "${{ inputs.use_local_images }}" == "true" ]; then
            export REGISTRY=""
          else
            export REGISTRY=${{ env.SKAFFOLD_DEFAULT_REPO }}
          fi
          
          docker compose -f compose.yaml up -d

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to start..."
          sleep 30
          docker compose -f compose.yaml ps

      - name: Check service health
        run: |
          echo "Checking service health..."
          # Install jq if not available
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi
          docker compose -f compose.yaml ps --format json | jq -r '.[] | "\(.Service): \(.State)"' || docker compose -f compose.yaml ps
          # Check if frontend reverse proxy is responding
          timeout 60 bash -c 'until curl -f http://localhost:80 > /dev/null 2>&1; do sleep 5; done' || echo "Frontend not yet ready"

      - name: Enable test environment
        env:
          REGISTRY: ${{ env.SKAFFOLD_DEFAULT_REPO }}
        run: |
          # Use tag from input (defaults to latest if not provided)
          # If tag is a full commit SHA, use first 7 characters (for compatibility)
          # Handles workflow_dispatch, workflow_call, and push triggers
          TAG_INPUT="${{ inputs.tag }}"
          if [ -n "$TAG_INPUT" ] && [ "$TAG_INPUT" != "latest" ]; then
            export TAG=$(echo "$TAG_INPUT" | cut -c 1-7)
          else
            export TAG=latest
          fi
          
          # If use_local_images is true, set REGISTRY to empty string to use local images
          if [ "${{ inputs.use_local_images }}" == "true" ]; then
            export REGISTRY=""
          else
            export REGISTRY=${{ env.SKAFFOLD_DEFAULT_REPO }}
          fi
          
          # Stop and remove existing containers that will be replaced with test versions
          docker compose -f compose.yaml stop credit-card-order-service third-party-service || true
          docker compose -f compose.yaml rm -f credit-card-order-service third-party-service || true
          
          # Get the image names (handle empty REGISTRY for local images)
          if [ -z "$REGISTRY" ]; then
            CREDIT_CARD_IMAGE="credit-card-order-service:${TAG}"
            THIRD_PARTY_IMAGE="third-party-service:${TAG}"
          else
            CREDIT_CARD_IMAGE="${REGISTRY}/credit-card-order-service:${TAG}"
            THIRD_PARTY_IMAGE="${REGISTRY}/third-party-service:${TAG}"
          fi
          
          # Start credit-card-order-service with test environment variables
          docker run -d --name credit-card-order-service \
            --network easytrade \
            --env WORK_DELAY=10 \
            --env WORK_RATE=10 \
            --env PROXY_PREFIX=credit-card-order-service \
            --env MSSQL_CONNECTIONSTRING="jdbc:sqlserver://db:1433;database=TradeManagement;user=sa;password=yourStrong(!)Password;encrypt=false;trustServerCertificate=false;loginTimeout=30;" \
            --env THIRD_PARTY_SERVICE_HOSTANDPORT=third-party-service:8080 \
            --env FEATURE_FLAG_SERVICE_PROTOCOL=http \
            --env FEATURE_FLAG_SERVICE_BASE_URL=feature-flag-service \
            --env FEATURE_FLAG_SERVICE_PORT=8080 \
            --env JAVA_TOOL_OPTIONS="-XX:-OmitStackTraceInFastThrow" \
            "${CREDIT_CARD_IMAGE}" || true
          
          # Start third-party-service with test environment variables
          docker run -d --name third-party-service \
            --network easytrade \
            --env COURIER_DELAY=10 \
            --env COURIER_RATE=10 \
            --env MANUFACTURE_DELAY=10 \
            --env MANUFACTURE_RATE=10 \
            --env PROXY_PREFIX=third-party-service \
            --env FEATURE_FLAG_SERVICE_PROTOCOL=http \
            --env FEATURE_FLAG_SERVICE_BASE_URL=feature-flag-service \
            --env FEATURE_FLAG_SERVICE_PORT=8080 \
            --env CREDIT_CARD_ORDER_SERVICE_HOSTANDPORT=credit-card-order-service:8080 \
            "${THIRD_PARTY_IMAGE}" || true

      - name: Wait for services to restart
        run: |
          echo "Waiting for services to restart with test environment settings..."
          sleep 10
          docker ps --filter "name=credit-card-order-service" --filter "name=third-party-service" --format "table {{.Names}}\t{{.Status}}"

      - name: Wait 3 minutes
        run: sleep 3m

      - name: Order credit card
        run: |
          BODY='{
            "accountId": 3,
            "email": "demo.user@dynatrace.com",
            "name": "Demo User",
            "shippingAddress": "ulica Andersa 352 91-682 Ilaw",
            "cardLevel": "Platinum"
          }'
          
          RESPONSE=$(docker run --rm --network easytrade curlimages/curl:latest \
            -sLX POST 'http://credit-card-order-service:8080/v1/orders' \
            -H 'accept: application/json' \
            -H 'Content-Type: application/json' \
            -d "${BODY}")
          echo "Card ordered, response: [${RESPONSE}]"

      - name: Wait 12 minutes
        run: sleep 12m

      - name: Check credit card order
        id: check-credit-card-order
        run: |
          # Install jq if not available
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi
          
          RESPONSE=$(docker run --rm --network easytrade curlimages/curl:latest \
            -sLX GET 'http://credit-card-order-service:8080/v1/orders/3/status/latest' \
            -H 'accept: application/json')
          echo "Response: [${RESPONSE}]"
          
          STATUS=$(echo $RESPONSE | jq -re '.results.status')
          echo "Latest card status: [${STATUS}]"
          
          if [[ "$STATUS" == "card_delivered" ]]; then
            echo "Credit card order test passed"
            echo "result=pass" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "::error::Credit card order test failed"
            echo "result=fail" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Send deployment event to Dynatrace (optional)
        # Send a business event to your Dynatrace tenant to track deployments
        # This is a simplified version that just sends events - no validation workflow needed
        # 
        # To use this, set these secrets in your repository:
        # - DYNATRACE_TENANT_URL: Your Dynatrace tenant URL (e.g., https://zsl01171.apps.dynatrace.com)
        # - DYNATRACE_PLATFORM_TOKEN: Your Dynatrace platform token with "Ingest business events" permission
        continue-on-error: true
        uses: ./.github/actions/send-deployment-event
        with:
          tenant_url: ${{ secrets.DYNATRACE_TENANT_URL }}
          platform_token: ${{ secrets.DYNATRACE_PLATFORM_TOKEN }}
          application_name: "easytrade"
          deployment_version: ${{ github.sha }}

      - name: Run validation (Dynatrace internal - optional)
        # This step is for Dynatrace's internal validation system and requires:
        # - OAuth client credentials (OQR_CLIENT_ID, OQR_CLIENT_SECRET)
        # - Access to Dynatrace SSO (SSO_URL)
        # - Dynatrace tenant with validation workflows (OQR_URL)
        # This step will be skipped if you don't have access to Dynatrace's internal systems
        # The workflow will continue even if this step fails
        continue-on-error: true
        uses: ./.github/actions/run-validation
        with:
          client_id: ${{ secrets.OQR_CLIENT_ID }}
          client_secret: ${{ secrets.OQR_CLIENT_SECRET }}
          sso_url: ${{ secrets.SSO_URL }}
          tenant_url: ${{ secrets.OQR_URL }}

      - name: Disable test environment
        env:
          REGISTRY: ${{ env.SKAFFOLD_DEFAULT_REPO }}
        run: |
          # Stop and remove test containers
          docker stop credit-card-order-service third-party-service || true
          docker rm credit-card-order-service third-party-service || true
          
          # Restore original containers using docker compose with tag from input (defaults to latest)
          # If tag is a full commit SHA, use first 7 characters (for compatibility)
          # Handles workflow_dispatch, workflow_call, and push triggers
          TAG_INPUT="${{ inputs.tag }}"
          if [ -n "$TAG_INPUT" ] && [ "$TAG_INPUT" != "latest" ]; then
            export TAG=$(echo "$TAG_INPUT" | cut -c 1-7)
          else
            export TAG=latest
          fi
          
          # If use_local_images is true, set REGISTRY to empty string to use local images
          if [ "${{ inputs.use_local_images }}" == "true" ]; then
            export REGISTRY=""
          else
            export REGISTRY=${{ env.SKAFFOLD_DEFAULT_REPO }}
          fi
          
          docker compose -f compose.yaml up -d credit-card-order-service third-party-service

